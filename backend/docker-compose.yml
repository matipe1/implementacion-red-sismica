services:
  db:
    image: postgres:16
    container_name: postgres-redsismica
    environment: # Podemos agregarlo a un .env para evitar dejarlas en texto plano (opcional)
      POSTGRES_USER: postgres
      POSTGRES_PASSWORD: admin
      POSTGRES_DB: red_sismica
      TZ: "America/Argentina/Buenos_Aires"
    ports:
      - "5433:5432" # Cambia a 5433:5432 si 5432 ya estÃ¡ usado en tu host
    volumes:
      - ./db/init:/docker-entrypoint-initdb.d        # ejecuta todos los .sql de /db/init
      - pgdata:/var/lib/postgresql/data              # volumen de datos (persistente)

    command: >
      bash -c "
        docker-entrypoint.sh postgres &
        sleep 5 &&
        psql -U postgres -d red_sismica -f /docker-entrypoint-initdb.d/01_schema.sql &&
        psql -U postgres -d red_sismica -f /docker-entrypoint-initdb.d/02_data.sql &&
        wait
      "
    
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres -d red_sismica"]
      interval: 5s
      timeout: 3s
      retries: 10
    restart: unless-stopped

volumes:
  pgdata:
